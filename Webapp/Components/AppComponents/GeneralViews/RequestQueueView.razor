@using Domain.Authentication
@using Domain.PurchaseRequests.Dto
@using Domain.PurchaseRequests.TypeConstants
@using Webapp.Services.Authentication
@using Webapp.Data

<style>
    .rz-panel-titlebar {
        flex-direction: row-reverse;
        justify-content:left;
    }
</style>
<RadzenPanel Collapsed="@this.Collapsed"
             AllowCollapse="true"
             CollapseTitle="Press to expand">
    <HeaderTemplate>
        <RadzenText TextStyle="TextStyle.H6" class="rz-display-flex rz-align-items-center rz-m-0">
            <RadzenIcon Icon="filter_list" class="rz-me-1"/><b>Queue</b>
        </RadzenText>
    </HeaderTemplate>
    <ChildContent>
        <RadzenDropZoneContainer TItem="PurchaseRequestStatus"
                                 Data="@this.PurchaseReqStatuses"
                                 CanDrop="args => false"
                                 ItemRender="@this.OnItemRender"
                                 ItemSelector="@this.ItemSelector">

            <ChildContent>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap" class="rz-p-1">
                    <RadzenDropZone Value="PrStatus.NeedsApproval" class="rz-display-flex rz-flex-column rz-background-color-warning-lighter rz-border-warning-light rz-border-radius-2 rz-p-4" Style="flex: 1; gap: 1rem;">
                        <RadzenText Text="Needs Approval" TextStyle="TextStyle.H6" TextAlign="TextAlign.Center"/>
                    </RadzenDropZone>

                    <RadzenDropZone Value="PrStatus.Approved"
                                    class="rz-display-flex rz-flex-column rz-background-color-info-lighter rz-border-info-light rz-border-radius-2 rz-p-4" Style="padding-bottom: 0; padding-right: 0; flex: 1; gap: 1rem;">
                        <RadzenText Text="Approved" TextStyle="TextStyle.H6" TextAlign="TextAlign.Center"/>
                    </RadzenDropZone>

                    <RadzenDropZone Value="PrStatus.Ordered"
                                    class="rz-display-flex rz-flex-column rz-background-color-success-lighter rz-border-success-light rz-border-radius-2 rz-p-4" Style="flex: 1; gap: 1rem;">
                        <RadzenText Text="Ordered" TextStyle="TextStyle.H6" TextAlign="TextAlign.Center"/>
                    </RadzenDropZone>

                    <RadzenDropZone Value="PrStatus.Delivered"
                                    class="rz-display-flex rz-flex-column rz-background-color-secondary-lighter rz-border-secondary-light rz-border-radius-2 rz-p-4" Style="flex: 1; gap: 1rem;">
                        <RadzenText Text="Delivered" TextStyle="TextStyle.H6" TextAlign="TextAlign.Center"/>
                    </RadzenDropZone>

                    <RadzenDropZone Value="PrStatus.Rejected"
                                    class="rz-display-flex rz-flex-column rz-background-color-danger-lighter rz-border-danger-light rz-border-radius-2 rz-p-4" Style="flex: 1; gap: 1rem;">
                        <RadzenText Text="Rejected" TextStyle="TextStyle.H6" TextAlign="TextAlign.Center"/>
                    </RadzenDropZone>
                </RadzenStack>
            </ChildContent>
            <Template Context="status">
                <RadzenSplitButton Click="@((item) => this.StatusClickedHandler(item, status.Id))"
                                   Text="@this.GetButtonText(status)"
                                   ButtonStyle="@this.GetButtonColor(status)"
                                   Shade="Shade.Darker"
                                   class="rz-radius-6"
                                   Style="width: 100%">
                    <ChildContent>
                        @switch (this._role) {
                            case nameof(PurchaseRequestRole.Requester): {
                                @if (status.Status == PrStatus.NeedsApproval || status.Status == PrStatus.Approved) {
                                    <RadzenSplitButtonItem Text="Modify" Icon="autorenew" IconColor="blue" Value="@nameof(PrUserAction.MODIFY)"/>
                                    <RadzenSplitButtonItem Text="Cancel" Icon="highlight_off" Value="@nameof(PrUserAction.CANCEL)"/>
                                }

                                break;
                            }
                            case nameof(PurchaseRequestRole.Approver): {
                                @if (status.Status == PrStatus.NeedsApproval || status.Status == PrStatus.Approved) {
                                    <RadzenSplitButtonItem Text="Approve/Reject" Icon="done_all" Value="@nameof(PrUserAction.APPROVE)"/>
                                }
                                break;
                            }
                            case nameof(PurchaseRequestRole.Purchaser): {
                                @if (status.Status == PrStatus.Approved) {
                                    <RadzenSplitButtonItem Icon="input" Text="Order Request" Value="@nameof(PrUserAction.ORDER)"/>
                                    <RadzenSplitButtonItem Text="Cancel" Icon="highlight_off" Value="@nameof(PrUserAction.CANCEL)"/>
                                } else if (status.Status == PrStatus.Ordered) {
                                    <RadzenSplitButtonItem Text="Check-in Order" Icon="input" Value="@nameof(PrUserAction.CHECKIN)"/>
                                }else if (status is { Status: PrStatus.Delivered, IsComplete: false }) {
                                    <RadzenSplitButtonItem Text="Check-in Order" Icon="input" Value="@nameof(PrUserAction.CHECKIN)"/>
                                }
                                break;
                            }
                        }
                    </ChildContent>
                </RadzenSplitButton>
            </Template>
        </RadzenDropZoneContainer>
    </ChildContent>

</RadzenPanel>


@code {
    [Inject] private UserService _userService { get; set; }
    [Parameter] public List<PurchaseRequestStatus> PurchaseReqStatuses { get; set; }
    [Parameter] public EventCallback<string> SelectedIdChanged { get; set; }
    [Parameter] public EventCallback<UserActionEventArg> UserAction { get; set; }
    [Parameter] public bool Collapsed { get; set; }
    private string _role = "";

    Func<PurchaseRequestStatus, RadzenDropZone<PurchaseRequestStatus>, bool> ItemSelector = (item, zone) => item.Status == (PrStatus)zone.Value;

    protected override void OnInitialized() {
        this._role = this._userService.GetUserRole();
        base.OnInitialized();
    }
    
    private ButtonStyle GetButtonColor(PurchaseRequestStatus status) {
        if (status is { IsComplete: false, Status: PrStatus.Delivered }) {
            return ButtonStyle.Warning;
        } else {
            return ButtonStyle.Secondary;
        }
    }

    private string GetButtonText(PurchaseRequestStatus status) {
        return status is {Status:PrStatus.Delivered, IsComplete:false} ? $"{status.Name} (Incomplete)" : status.Name;
    }
    
    

    void OnItemRender(RadzenDropZoneItemRenderEventArgs<PurchaseRequestStatus> args) {
        args.Attributes["draggable"] = "false";
        args.Attributes["style"] = "padding-right:.1rem; padding-left:.1rem; padding-top:.1rem; padding-bottom:.1rem;";
        args.Attributes["class"] = "rz-card rz-variant-filled";
        //args.Visible = args.Item.Status != PrStatus.Delivered;
        //rz-background-color-primary-light rz-color-on-primary-light
    }

    async Task StatusClickedHandler(RadzenSplitButtonItem? item, string id) {
        if (item != null) {
            if (Enum.TryParse(typeof(PrUserAction), item.Value, out var action)) {
                await this.UserAction.InvokeAsync(new UserActionEventArg((PrUserAction)action, id));
            }
        } else {
            await this.SelectedIdChanged.InvokeAsync(id);
        }
    }

}