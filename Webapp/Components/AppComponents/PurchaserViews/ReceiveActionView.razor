@using Domain.PurchaseRequests.Dto
@using Domain.PurchaseRequests.Dto.ActionInputs
@using Domain.PurchaseRequests.Model
@using Domain.PurchaseRequests.TypeConstants
@using Domain.Users
@using Infrastructure.Services
@using SETiAuth.Domain.Shared.Authentication
@using TimeProvider = Infrastructure.Services.TimeProvider
@using Webapp.Services.Authentication
@using Webapp.Services
<RadzenCard class="info-area">
    <RadzenSteps>
        <Steps>
            <RadzenStepsItem Text="Mark Received" NextText="Internal Emails">
                <ItemReceiveStatusView @bind-ItemDelivery="@this._receiveRequestInput.ItemDelivery"/>
            </RadzenStepsItem>
            <RadzenStepsItem Text="Internal Emails" NextText="Finalize" PreviousText="Mark Received">
                <RadzenFieldset Text="Email Recipients">
                    <RadzenText TextStyle="TextStyle.H6" Text="Emails will be sent to the following users:"/>
                    <RadzenText Text="@String.Join(" , ", this._emailList)" TextStyle="TextStyle.Subtitle1"/>
                </RadzenFieldset>
                <EmailPickList CcList="@this._ccList"
                               CcListChanged="EmailListChangedHandler"
                               TextStyle="TextStyle.Body1"
                               IsCollapsed="true"/>
            </RadzenStepsItem>
            <RadzenStepsItem Text="Finalize" PreviousText="Internal Emails">
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenStack>
                            <RadzenCard class="info-area">
                                <RadzenText TextStyle="TextStyle.H6" TextAlign="TextAlign.Center">
                                    Check email preview and items received before submitting
                                </RadzenText>
                            </RadzenCard>
                            <RadzenStack Orientation="Orientation.Horizontal"
                                         AlignItems="AlignItems.Center"
                                         JustifyContent="JustifyContent.Center">
                                <RadzenButton Text="Submit Cancellation"
                                              Icon="check_circle"
                                              Click="@this.SubmitHandler"
                                              Disabled="@(!this._docLoaded)"
                                              Style="width: 180px; height: 70px;"/>
                                <RadzenButton Text="Cancel Cancellation"
                                              Icon="delete"
                                              ButtonStyle="ButtonStyle.Danger"
                                              Click="@this.CancelHandler"
                                              Style="width: 180px; height: 70px;"/>
                            </RadzenStack>
                            <RadzenDataGrid TItem="ItemDeliveryStatus"
                                            Data="@this._receiveRequestInput.ItemDelivery"
                                            Density="Density.Compact">
                                <Columns>
                                    <RadzenDataGridColumn Property="@nameof(ItemDeliveryStatus.Item)" Title="Item"/>
                                    <RadzenDataGridColumn Property="@nameof(ItemDeliveryStatus.Location)" Title="Location"/>
                                    <RadzenDataGridColumn Property="@nameof(ItemDeliveryStatus.Received)" Title="Received?">
                                        <Template Context="data">
                                            <RadzenText Text="@(data.Received ? "Received" : "Incoming")"></RadzenText>
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenStack>
                            <RadzenCard Variant="Variant.Outlined" class="area-header">
                                <RadzenText Text="Email Preview" TextStyle="TextStyle.H5" TextAlign="TextAlign.Center"/>
                            </RadzenCard>
                            @*<DxRichEdit @ref="@this._richEdit"
                                        @bind-DocumentContent="@this._documentContent"
                                        DocumentLoaded="@this.DocumentLoadedHandler"
                                        DocumentFormat="DocumentFormat.OpenXml"
                                        BarMode="BarMode.None"
                                        ViewType="ViewType.Simple"
                                        CssClass="rz-w-100"
                                        ReadOnly="true">
                                <MailMergeSettings>
                                    <DxMailMergeSettings Data="@this.MailMerge"
                                                         ViewMergedData="true"
                                                         ActiveRecord="1"/>
                                </MailMergeSettings>
                            </DxRichEdit>*@
                            <DxRichEdit @ref="@this._richEdit"
                                        @bind-DocumentContent="@this._documentContent"
                                        DocumentLoaded="@this.DocumentLoadedHandler"
                                        DocumentFormat="DocumentFormat.OpenXml"
                                        BarMode="BarMode.None"
                                        ViewType="ViewType.Simple"
                                        CssClass="rz-w-100"
                                        ReadOnly="false">
                                <MailMergeSettings>
                                    <DxMailMergeSettings Data="@this.MailMerge"
                                                         ViewMergedData="true"
                                                         ActiveRecord="1"/>
                                </MailMergeSettings>
                            </DxRichEdit>
                            
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
                
            </RadzenStepsItem>
        </Steps>
    </RadzenSteps>
</RadzenCard>


@code {
    [Inject] private IWebHostEnvironment _environment { get; set; }
    [Inject] private SpinnerService _spinnerService { get; set; }
    [Inject] private NotificationService _notificationService { get; set; }
    [Inject] private PurchaseRequestService _purchaseRequestService { get; set; }
    [Parameter] public UserProfile UserProfile { get; set; }
    [Parameter] public PurchaseRequest? PurchaseRequest { get; set; } 
    [Parameter] public EventCallback<string> ActionCompleted { get; set; }
    
    private DxRichEdit? _richEdit;
    private bool _emailsLoaded = false;
    private bool _docLoaded = false;
    private List<string> _ccList = [];
    private List<string> _emailList = [];
    private byte[] _documentContent;
    private byte[] _mailDocument;
    private string? _comments { get; set; }
    private List<ReceiveMailMerge> MailMerge { get; set; } = [];
    private ReceiveRequestInput _receiveRequestInput = new();
    private bool _previewCollapsed = true;

    protected override async Task OnInitializedAsync() { 
        await base.OnInitializedAsync();
        await Load();
    }
    
    private async Task SubmitHandler() {
        if(this.PurchaseRequest==null) {
            return;
        }
        this._spinnerService.Show("Submitting Cancellation Request");
        var merge = new ReceiveMailMerge() {
            PrAction = "Received Items",
            Title = this.PurchaseRequest?.Title ?? "", 
            Requester = this.PurchaseRequest?.Requester.Name ?? "",
            Receiver = this.UserProfile.FirstName + " " + this.UserProfile.LastName,
            ReceiveComments = this._comments ?? "",
        };
        if (this._receiveRequestInput.ItemDelivery.Any()) {
            for(int i=1;i<this._receiveRequestInput.ItemDelivery.Count-1;i++) {
                merge.SetItem(i, this._receiveRequestInput.ItemDelivery[i].Item ?? "", 
                    this._receiveRequestInput.ItemDelivery[i].Location ?? "",
                    this._receiveRequestInput.ItemDelivery[i].Received);
            }
        }
        this.MailMerge = [merge];
        this._mailDocument=await this._richEdit.DocumentAPI.MailMergeAsync(DocumentFormat.Html);
        /*var success=await this._purchaseRequestService.CancelPurchaseRequest(input);
        if (success) {
            this._notificationService.Notify(NotificationSeverity.Success, 
                "Cancellation Request Submitted",
                "The cancellation request has been submitted successfully");
        } else {
            this._notificationService.Notify(NotificationSeverity.Success, 
                "Cancellation Request Error",
                "There was an error submitting the cancellation request");
        }*/
        this._spinnerService.Hide();
        await this.ActionCompleted.InvokeAsync(this.PurchaseRequest._id.ToString());
    }
    
    private async Task CancelHandler() {
        await this.ActionCompleted.InvokeAsync(this.PurchaseRequest?._id.ToString());
    }
    
    private Task EmailListChangedHandler(List<string> ccList) {
        this._ccList = ccList;
        if(this.PurchaseRequest == null) {
            return Task.CompletedTask;
        }
        this.PurchaseRequest.EmailCopyList = ccList;
        return Task.CompletedTask;
    }
    
    private async Task CommentsChangedHandler(string value) {
        this._comments = value;
        var merge = new ReceiveMailMerge() { Title = this.PurchaseRequest?.Title ?? "", Requester = this.PurchaseRequest?.Requester.Name ?? "", };
        if (this._receiveRequestInput.ItemDelivery.Any()) {
            for(int i=1;i<this._receiveRequestInput.ItemDelivery.Count-1;i++) {
                merge.SetItem(i, this._receiveRequestInput.ItemDelivery[i].Item ?? "", 
                    this._receiveRequestInput.ItemDelivery[i].Location ?? "",
                    this._receiveRequestInput.ItemDelivery[i].Received);
            }
        }
        this.MailMerge = [merge];
        this._mailDocument=await this._richEdit.DocumentAPI.MailMergeAsync(DocumentFormat.Html);
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task DocumentLoadedHandler(Document obj) {
        var merge = new ReceiveMailMerge() { Title = this.PurchaseRequest?.Title ?? "", Requester = this.PurchaseRequest?.Requester.Name ?? "", };
        if (this._receiveRequestInput.ItemDelivery.Any()) {
            for(int i=0;i<this._receiveRequestInput.ItemDelivery.Count-1;i++) {
                merge.SetItem(i+1, this._receiveRequestInput.ItemDelivery[i].Item ?? "", 
                    this._receiveRequestInput.ItemDelivery[i].Location ?? "",
                    this._receiveRequestInput.ItemDelivery[i].Received);
                this._notificationService.Notify(NotificationSeverity.Info, 
                    "Item",merge[i+1],duration:3000);
            }
        }

        merge.Receiver = this._receiveRequestInput.Receiver.Name;
        merge.ReceiveComments = "Comments for testing";
        this.MailMerge = [merge];
        this._mailDocument=await this._richEdit.DocumentAPI.MailMergeAsync(DocumentFormat.Html);
        this._docLoaded = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task Load() {
        this._documentContent=await File.ReadAllBytesAsync($"{this._environment.WebRootPath}/MailTemplateFiles/ReceiveTemplate.docx");
        if (this.PurchaseRequest != null) {
            if (this.PurchaseRequest.Status==PrStatus.Ordered) {
                this._receiveRequestInput.ItemDelivery = this.PurchaseRequest.PurchaseItems.Select(e => 
                        new ItemDeliveryStatus() { Item = e.ProductName, Received = false, Location = "",ReceivedDate = TimeProvider.Now()})
                    .ToList();
            }else if (this.PurchaseRequest.Status == PrStatus.PartialDelivered) {
                this._receiveRequestInput.ItemDelivery = this.PurchaseRequest.ItemDelivery;
            }
            this._receiveRequestInput.RequestId=this.PurchaseRequest._id;
            this._receiveRequestInput.IsPartial = false;
            this._receiveRequestInput.Receiver = new PrReceiver() { 
                Email = this.UserProfile.Email, 
                Name = this.UserProfile.FirstName + " " + this.UserProfile.LastName, 
                Username = this.UserProfile._id
            };
            var merge = new ReceiveMailMerge() { 
                Title = this.PurchaseRequest?.Title ?? "", 
                Requester = this.PurchaseRequest?.Requester.Name ?? "", };
            /*if (this._receiveRequestInput.ItemDelivery.Any()) {*/
            for(int i=0;i<this._receiveRequestInput.ItemDelivery.Count-1;i++) {
                merge.SetItem(i+1, this._receiveRequestInput.ItemDelivery[i].Item ?? "", 
                    this._receiveRequestInput.ItemDelivery[i].Location ?? "",
                    this._receiveRequestInput.ItemDelivery[i].Received);
                this._notificationService.Notify(NotificationSeverity.Info, 
                    "Item",merge[i+1],duration:3000);
            }
            
            this.MailMerge = [merge];
            this._emailList.Add(this.PurchaseRequest.Requester?.Email ?? "");
            this._emailList.Add(this.PurchaseRequest.Approver?.Email ?? "");
            this._emailList.Add(this._receiveRequestInput.Receiver?.Email ?? "");
            this._ccList.AddRange(this.PurchaseRequest.EmailCopyList);
        }
        
    }

}