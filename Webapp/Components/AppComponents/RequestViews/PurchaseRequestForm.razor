@using Domain.PurchaseRequests
@using Domain.PurchaseRequests.Dto
@using Domain.PurchaseRequests.Model
@using Domain.Users
@using Infrastructure.Services
@using Microsoft.Extensions.Options
@using MongoDB.Bson
@using SETiAuth.Domain.Shared.Authentication
@using Webapp.Services.Authentication

@if (!(this._userAccount != null && this._approvers.Count > 0 && this._purchaseReqInput != null)) {
    <RadzenText Text="Loading User Profile"/>
} else {
    <RadzenStack Orientation="Orientation.Horizontal">
        <RadzenCard Style="width: 100%;">
            <RadzenStack>
                <RadzenCard class="rz-background-color-series-4">
                    <RadzenText Text="Purchase Request Form" TextStyle="TextStyle.H6"/>
                    <RadzenText Text="Please fill out the form below to submit a purchase request."
                                TextStyle="TextStyle.Body1"/>
                </RadzenCard>
                <RadzenCard class="rz-background-color-info">
                    <RadzenStack Orientation="Orientation.Vertical">
                        <RadzenStack Orientation="Orientation.Horizontal" 
                                     AlignItems="AlignItems.Center" 
                                     JustifyContent="JustifyContent.Center">
                            <RadzenFormField Text="Approver">
                                <RadzenDropDown TValue="string"
                                                Data="@this._approverSelectList"
                                                Value="@this._selectedApprover"
                                                ValueChanged="@SelectedApproverChanged"
                                                Placeholder="Select an approver"
                                                AllowClear="true"/>
                            </RadzenFormField>
                            <div class="rz-p-12 rz-text-align-center">
                                <RadzenCheckBox TriState=false @bind-Value="@this._isUrgent" Name="IsUrgent"/>
                                <RadzenLabel Text="Urgent" Component="IsUrgent" class="rz-ms-2"/>
                            </div>
                        </RadzenStack>
                        <RadzenTabs Style="height:100%">
                            <Tabs>
                                <RadzenTabsItem Text="Department/Vendor">
                                    <RadzenStack Orientation="Orientation.Vertical">
                                        <RadzenFieldset Text="Department">
                                            <RadzenDropDown TValue="Department"
                                                            Data="@this._departments"
                                                            Value="@this._purchaseReqInput.Department"
                                                            Placeholder="Select a department"
                                                            TextProperty="Name"
                                                            AllowClear="true"/>
                                        </RadzenFieldset>
                                        <RadzenFieldset Text="Vendor">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                                <RadzenDropDown TValue="Vendor"
                                                                Data="@this._vendors"
                                                                Value="@this._purchaseReqInput.Vendor"
                                                                ValueChanged="@SelectedVendorChanged"
                                                                TextProperty="Name"
                                                                Placeholder="Select an vendor"
                                                                AllowClear="true"/>
                                                <RadzenButton Text="Add Vendor" Click="CreateNewVendor" ButtonStyle="ButtonStyle.Secondary" Shade="Shade.Darker"/>
                                                <VendorView Vendor="@this._purchaseReqInput.Vendor"/>
                                            </RadzenStack>
                                        </RadzenFieldset>
                                    </RadzenStack>
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Purchase Information">
                                    <RadzenStack>
                                        <RadzenFormField Text="Requester">
                                            <RadzenTextBox @bind-Value="@this._userAccount.FirstName"/>
                                        </RadzenFormField>
                                        <RadzenFormField Text="Purchase Request Title">
                                            <RadzenTextBox Placeholder="Enter the title of the purchase request"
                                                           @bind-Value="@this._purchaseReqInput.Title"
                                                           Style="width: 100%"/>
                                        </RadzenFormField>
                                        <RadzenFormField Text="Purchase Request Reason">
                                            <RadzenTextArea Placeholder="Enter a brief description of the purchase request"
                                                            @bind-Value="@this._purchaseReqInput.Description"
                                                            Style="width: 100%; height:100px;"/>
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Message">
                                    <RadzenStack>
                                        <RadzenFormField Text="Additional Comments">
                                            <RadzenTextArea Placeholder="Enter any additional message you would like appended to the email"
                                                            @bind-Value="@this._purchaseReqInput.AdditionalComments"
                                                            Style="width: 200px; height:100px;"/>
                                        </RadzenFormField>
                                        <RadzenFormField Text="Upload Quotes">
                                            <RadzenUpload Multiple="true"
                                                          ChooseText="Select File"
                                                          Change="@this.OnClientChange"/>
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenTabsItem>
                            </Tabs>
                        </RadzenTabs>
                        <RadzenFieldset Text="Save/Cancel">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                                <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Success" Shade="Shade.Darker"
                                              Click="@SavePurchaseRequestHandler"
                                              Style="width: 180px;height: 50px;"/>
                                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Danger"
                                              Click="@CancelPurchaseRequestHandler"
                                              Style="width: 180px;height: 50px;"/>
                            </RadzenStack>
                        </RadzenFieldset>
                    </RadzenStack>
                </RadzenCard>
            </RadzenStack>
        </RadzenCard>
    </RadzenStack>
}

@code {
    [Inject] private AuthApiService _authApiService { get; set; }
    [Inject] private IWebHostEnvironment environment { get; set; }
    [Inject] private UserService _userService { get; set; }
    [Inject] private DialogService _dialogService { get; set; }
    [Inject] private PurchaseRequestService _purchaseRequestService { get; set; }
    [Inject] private NotificationService _notificationService { get; set; }
    private RadzenUpload _upload;
    private PurchaseRequestInput? _purchaseReqInput;
    private string? _selectedApprover;
    private bool _isUrgent = false;
    private List<UserAccountDto> _approvers = [];
    private List<string> _approverSelectList = [];
    private UserProfile? _userAccount = new();
    private UserAccountDto? _approverAccount = new();
    private List<Department> _departments = new();
    private List<string> _shippingTypes = new();
    private List<Vendor> _vendors = new();
    
    
    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        this._approvers = await this._authApiService.GetApprovers();
        this._userAccount = this._userService.GetSessionUserProfile();
        this._approverSelectList = this._approvers.Select(e => e.FirstName).ToList();
        this._vendors=await this._purchaseRequestService.GetVendors();
        this._departments = await this._purchaseRequestService.GetDepartments();
        if(this._userAccount!=null) {
            this._purchaseReqInput = new PurchaseRequestInput() {
                RequesterName = this._userAccount?.FirstName + " " + this._userAccount?.LastName,
                RequesterEmail = this._userAccount?.Email,
                RequesterUsername = this._userAccount?._id,
                Id=ObjectId.GenerateNewId(),
            };
        }
    }
    
    bool CanCreatePurchaseRequest() {
        return this._userAccount != null && this._approvers.Count > 0 && this._purchaseReqInput != null;
    }
    
    async Task OnClientChange(UploadChangeEventArgs args) {
        Console.WriteLine($"Client-side upload changed");
        foreach (var file in args.Files) {
            /*Console.WriteLine($"File: {file.Name} / {file.Size} bytes");*/
            try {
                long maxFileSize = 10 * 1024 * 1024;
                // read file
                var stream = file.OpenReadStream(maxFileSize);
                this._userAccount = this._userService.GetSessionUserProfile();
                string filePath = Path.Combine(environment.WebRootPath,this._userAccount?._id ?? "Unknown");
                DirectoryInfo info = new DirectoryInfo(filePath);
                if (!info.Exists) {
                    info.Create();
                }
                file.Name=file.Name.Replace(".",$"_{this._purchaseReqInput?.Id.ToString()}.");
                string path = Path.Combine(filePath, file.Name);
                await using FileStream outputFileStream = new FileStream(path, FileMode.Create);
                await stream.CopyToAsync(outputFileStream);
                stream.Close();
                this._purchaseReqInput?.Quotes.Add(path);
                this._notificationService.Notify(NotificationSeverity.Success, 
                    "Quote Uploaded",
                    $"File: {file.Name} has been uploaded successfully");
                Console.WriteLine(path);
            } catch (Exception ex) {
                this._notificationService.Notify(NotificationSeverity.Error, 
                    "Internal Error",
                    $"Client-side file read error: {ex.Message}");
                Console.WriteLine($"Client-side file read error: {ex.Message}");
            }
        }
    }
    
    private async Task SelectedApproverChanged(string? selected) {
        this._selectedApprover = selected;
        this._approverAccount=this._approvers.FirstOrDefault(a => a.FirstName == selected);
        if (this._purchaseReqInput != null) {
            this._purchaseReqInput.ApproverName=this._approverAccount?.FirstName+" "+this._approverAccount?.LastName;
            this._purchaseReqInput.ApproverEmail=this._approverAccount?.Email;
        }
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task SelectedVendorChanged(Vendor? selected) {
        //this._selectedVendor = selected;
        this._purchaseReqInput.Vendor=selected;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SavePurchaseRequestHandler() {
        if(this._purchaseReqInput==null) {
            this._notificationService.Notify(NotificationSeverity.Error, 
                "Internal Error",
                "Purchase Request Input is null");
            return;
        }
        var success=await this._purchaseRequestService.CreatePurchaseRequest(this._purchaseReqInput);
        if(success) {
            this._notificationService.Notify(NotificationSeverity.Success, 
                "Success",
                "Purchase Request has been submitted successfully");
        } else {
            this._notificationService.Notify(NotificationSeverity.Error, 
                "Error",
                "Purchase Request submission failed");
        }
        this._dialogService.CloseSide();
    }
    

    private Task CancelPurchaseRequestHandler() {
        var enumerable = this._purchaseReqInput?.Quotes;
        if (enumerable != null) {
            foreach (var quote in enumerable) {
                if (File.Exists(quote)) {
                    File.Delete(quote);
                }
            }
        }
        this._dialogService.CloseSide();
        return Task.CompletedTask;
    }

    private Task CreateNewVendor() {
        this._notificationService.Notify(NotificationSeverity.Warning, 
            "Feature Not Implemented",
            "Create Vendor feature is not yet implemented yet");
        return Task.CompletedTask;
    }

}