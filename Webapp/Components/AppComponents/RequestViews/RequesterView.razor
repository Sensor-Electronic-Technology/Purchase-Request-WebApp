@page "/RequesterView"
@using System.Text.Json
@using Domain.Authentication
@using Domain.PurchaseRequests
@using Domain.PurchaseRequests.Dto
@using Domain.PurchaseRequests.Model
@using Domain.PurchaseRequests.TypeConstants
@using Domain.Users
@using Infrastructure.Services
@using Webapp.Data
@using Webapp.Services
@using Webapp.Services.Authentication
@rendermode InteractiveServer
@attribute [Authorize(Roles = $"{nameof(PurchaseRequestRole.Requester)}, {nameof(PurchaseRequestRole.Admin)}")]

<RadzenTabs @bind-SelectedIndex="@this._selectedIndex">
    <Tabs>
        <RadzenTabsItem Icon="add_shopping_cart" Text="Overview" Style="background:#4a764a">
            <PurchaseRequestsTable PurchaseRequests="@this._purchaseRequests" 
                                   ModifyRequest="@this.EditHandler"
                                   @bind-SelectedPurchaseRequest="@this._selectedRequest"/>
            <RequestQueueView PurchaseReqStatuses="@this._purchaseReqStatuses"/>
        </RadzenTabsItem>
        <RadzenTabsItem Icon="add_shopping_cart" Text="Create New" Style="background: #0a53be">
            <PurchaseRequestForm CancelCallback="@this.CancelHandler" SaveCallback="@this.SaveHandler"/>
        </RadzenTabsItem>
        <RadzenTabsItem Text="@this._templateTabText" Visible="@this._templateTabVisible"
                        Style="background: #cc7119">
            <PurchaseRequestView PurchaseRequest="@this._actionRequest"/>
            @*@switch(this._selectedIndex) {
                case 0:
                    <PurchaseRequestsTable PurchaseRequests="@this._purchaseRequests" @bind-SelectedPurchaseRequest="@this._selectedRequest"/>
                    break;
                case 1:
                    <PurchaseRequestForm CancelCallback="@this.CancelHandler" SaveCallback="@this.SaveHandler"/>
                    break;
                case 2:
                    <PurchaseRequestForm CancelCallback="@this.CancelHandler" SaveCallback="@this.SaveHandler"/>
                    break;
            }*@
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    [Inject] private PurchaseRequestService _purchaseRequestService { get; set; }
    [Inject] private DialogService _dialogService { get; set; }
    [Inject] private UserService _userService { get; set; }
    
    private RadzenDataGrid<PurchaseRequest> _dataGrid;
    private List<PurchaseRequest> _purchaseRequests = [];
    private List<PurchaseRequestStatus> _purchaseReqStatuses = [];
    private PurchaseRequest? _selectedRequest;
    private PurchaseRequest? _actionRequest;
    private UserProfile? _userAccount = new();
    private bool _templateTabVisible = false;
    private string _templateTabText="Template";
    
    private int _selectedIndex = 0;
    private EditMode _requestFormMode = EditMode.NEW;
    
    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        this._userAccount = this._userService.GetSessionUserProfile();
        if(this._userAccount != null) {
            this._purchaseRequests = await this._purchaseRequestService.GetUserPurchaseRequests(pr=>pr.Requester == this._userAccount._id);
            this._purchaseReqStatuses=this._purchaseRequests.Select(pr=>new PurchaseRequestStatus(pr._id.ToString(),pr.Title ?? "No Title", pr.Status)).ToList();
            Console.WriteLine("Done Fetching Purchase Requests");
            foreach (var request in this._purchaseRequests) {
                Console.WriteLine(request.Title);
            }
        }
    }
    
    private async Task CancelHandler() {
        this._templateTabVisible = false;
        this._selectedIndex = 0;
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task EditHandler() {
        this._actionRequest = this._selectedRequest;
        this._templateTabVisible = true;
        this._templateTabText = "Modify Request";
        this._selectedIndex = 2;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveHandler() {
        this._templateTabVisible = false;
        this._selectedIndex = 0;
        await this.Reload();
        await InvokeAsync(StateHasChanged);
    }

    private Task CancelRequestHandler(PurchaseRequest request) {
        Console.WriteLine(JsonSerializer.Serialize(request, new JsonSerializerOptions { WriteIndented = true }));
        return Task.CompletedTask;
    }
    
    private async Task Reload() {
        this._purchaseRequests = await this._purchaseRequestService.GetUserPurchaseRequests(pr=>pr.Requester == this._userAccount._id);
        Console.WriteLine("Reloading Purchase Requests");
    }

    private Task ShowRequestFormHandler() {
        this._templateTabVisible = !this._templateTabVisible;
        this._requestFormMode=EditMode.NEW;
        return Task.CompletedTask;
    }
    

}